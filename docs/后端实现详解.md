# AI é›¶ä»£ç åº”ç”¨ç”Ÿæˆå¹³å° - åç«¯å®ç°è¯¦è§£

> æœ¬æ–‡æ¡£è¯¦ç»†è§£é‡Šåç«¯æ¶æ„ã€API è®¾è®¡ã€æ•°æ®æµç¨‹å’Œå…³é”®æŠ€æœ¯å®ç°ã€‚

## ğŸ“‹ ç›®å½•

1. [åç«¯æ•´ä½“æ¶æ„](#1-åç«¯æ•´ä½“æ¶æ„)
2. [æ ¸å¿ƒä¸šåŠ¡æµç¨‹](#2-æ ¸å¿ƒä¸šåŠ¡æµç¨‹)
3. [API æ¥å£è®¾è®¡](#3-api-æ¥å£è®¾è®¡)
4. [AI ä»£ç ç”Ÿæˆå®ç°](#4-ai-ä»£ç ç”Ÿæˆå®ç°)
5. [æ•°æ®å­˜å‚¨è®¾è®¡](#5-æ•°æ®å­˜å‚¨è®¾è®¡)
6. [å®‰å…¨ä¸é™æµæœºåˆ¶](#6-å®‰å…¨ä¸é™æµæœºåˆ¶)
7. [æµå¼å“åº”å®ç°](#7-æµå¼å“åº”å®ç°)
8. [éƒ¨ç½²ä¸è¿ç»´](#8-éƒ¨ç½²ä¸è¿ç»´)
9. [å‰ç«¯è°ƒç”¨ç¤ºä¾‹](#9-å‰ç«¯è°ƒç”¨ç¤ºä¾‹)
10. [å¸¸è§é—®é¢˜è§£ç­”](#10-å¸¸è§é—®é¢˜è§£ç­”)

## 1. åç«¯æ•´ä½“æ¶æ„

### 1.1 æŠ€æœ¯æ ˆæ¦‚è§ˆ

```
åç«¯æŠ€æœ¯æ ˆ
â”œâ”€â”€ æ ¸å¿ƒæ¡†æ¶: Spring Boot 3.5.4 + Java 21
â”œâ”€â”€ AI æ¡†æ¶: LangChain4j 1.1.0 + LangGraph4j 1.6.0
â”œâ”€â”€ æ•°æ®åº“: MySQL + MyBatis-Flex
â”œâ”€â”€ ç¼“å­˜: Redis + Caffeine
â”œâ”€â”€ æ¶ˆæ¯: Reactor (å“åº”å¼ç¼–ç¨‹)
â”œâ”€â”€ å®‰å…¨: Spring Session + Redisson
â””â”€â”€ ç›‘æ§: Spring Boot Actuator + Prometheus
```

### 1.2 åˆ†å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è¡¨ç°å±‚ (Controller)                        â”‚
â”‚  â€¢ æ¥æ”¶ HTTP è¯·æ±‚                                          â”‚
â”‚  â€¢ å‚æ•°æ ¡éªŒå’Œæƒé™æ§åˆ¶                                      â”‚
â”‚  â€¢ è°ƒç”¨ä¸šåŠ¡æœåŠ¡                                            â”‚
â”‚  â€¢ è¿”å›å“åº”ç»“æœ                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ä¸šåŠ¡å±‚ (Service)                         â”‚
â”‚  â€¢ ä¸šåŠ¡é€»è¾‘å¤„ç†                                            â”‚
â”‚  â€¢ äº‹åŠ¡ç®¡ç†                                                â”‚
â”‚  â€¢ è°ƒç”¨ AI æœåŠ¡                                            â”‚
â”‚  â€¢ æ•°æ®æŒä¹…åŒ–                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    AI æœåŠ¡å±‚ (AI Service)                   â”‚
â”‚  â€¢ LangChain4j é›†æˆ                                        â”‚
â”‚  â€¢ AI æ¨¡å‹è°ƒç”¨                                             â”‚
â”‚  â€¢ å·¥å…·è°ƒç”¨ç®¡ç†                                            â”‚
â”‚  â€¢ å¯¹è¯è®°å¿†ç®¡ç†                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  å·¥ä½œæµå±‚ (LangGraph4j)                     â”‚
â”‚  â€¢ å¤æ‚ AI å·¥ä½œæµç¼–æ’                                       â”‚
â”‚  â€¢ èŠ‚ç‚¹æ‰§è¡Œç®¡ç†                                            â”‚
â”‚  â€¢ çŠ¶æ€æµè½¬æ§åˆ¶                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ•°æ®å±‚ (Mapper)                          â”‚
â”‚  â€¢ æ•°æ®åº“æ“ä½œ                                              â”‚
â”‚  â€¢ SQL æ‰§è¡Œ                                                â”‚
â”‚  â€¢ ç»“æœæ˜ å°„                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    åŸºç¡€è®¾æ–½å±‚                               â”‚
â”‚  â€¢ Redis ç¼“å­˜                                              â”‚
â”‚  â€¢ æ–‡ä»¶ç³»ç»Ÿ                                                â”‚
â”‚  â€¢ å¤–éƒ¨æœåŠ¡é›†æˆ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æ ¸å¿ƒåŒ…ç»“æ„

```
src/main/java/com/yupi/yuaicodemother/
â”œâ”€â”€ controller/           # æ§åˆ¶å™¨å±‚ - å¤„ç† HTTP è¯·æ±‚
â”œâ”€â”€ service/             # ä¸šåŠ¡æœåŠ¡å±‚ - ä¸šåŠ¡é€»è¾‘å¤„ç†
â”œâ”€â”€ ai/                  # AI æœåŠ¡å±‚ - AI ä»£ç ç”Ÿæˆæ ¸å¿ƒ
â”œâ”€â”€ core/                # æ ¸å¿ƒä¸šåŠ¡å±‚ - ä»£ç ç”Ÿæˆé—¨é¢
â”œâ”€â”€ langgraph4j/         # å·¥ä½œæµå¼•æ“ - å¤æ‚ AI å·¥ä½œæµ
â”œâ”€â”€ mapper/              # æ•°æ®è®¿é—®å±‚ - æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ model/               # æ•°æ®æ¨¡å‹ - DTOã€Entityã€VO
â”œâ”€â”€ config/              # é…ç½®ç±» - å„ç§é…ç½®
â”œâ”€â”€ exception/           # å¼‚å¸¸å¤„ç† - ç»Ÿä¸€å¼‚å¸¸ç®¡ç†
â”œâ”€â”€ ratelimter/          # é™æµæœºåˆ¶ - åˆ†å¸ƒå¼é™æµ
â”œâ”€â”€ monitor/             # ç›‘æ§ç³»ç»Ÿ - AI æœåŠ¡ç›‘æ§
â””â”€â”€ utils/               # å·¥å…·ç±» - é€šç”¨å·¥å…·æ–¹æ³•
```

## 2. æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 2.1 AI ä»£ç ç”Ÿæˆæµç¨‹

```
ç”¨æˆ·è¯·æ±‚ â†’ æƒé™éªŒè¯ â†’ AI æœåŠ¡è°ƒç”¨ â†’ ä»£ç ç”Ÿæˆ â†’ ä»£ç è§£æ â†’ æ–‡ä»¶ä¿å­˜ â†’ æµå¼è¿”å›
    â†“           â†“           â†“           â†“         â†“         â†“         â†“
  å‚æ•°æ ¡éªŒ   ç”¨æˆ·èº«ä»½    æ¨¡å‹é€‰æ‹©    æç¤ºè¯    ç»“æœå¤„ç†   è¯­æ³•æ£€æŸ¥   æœ¬åœ°å­˜å‚¨   å®æ—¶å“åº”
```

### 2.2 åº”ç”¨åˆ›å»ºæµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ æ™ºèƒ½è·¯ç”± â†’ ç±»å‹é€‰æ‹© â†’ åº”ç”¨åˆ›å»º â†’ æ•°æ®åº“å­˜å‚¨ â†’ è¿”å›åº”ç”¨ID
    â†“         â†“         â†“         â†“         â†“         â†“
  åˆå§‹åŒ–æç¤ºè¯  AIåˆ†æ   ä»£ç ç±»å‹   æ„é€ å¯¹è±¡   æ’å…¥æ•°æ®   åˆ›å»ºæˆåŠŸ
```

### 2.3 åº”ç”¨éƒ¨ç½²æµç¨‹

```
éƒ¨ç½²è¯·æ±‚ â†’ æƒé™éªŒè¯ â†’ ä»£ç æ£€æŸ¥ â†’ æ–‡ä»¶æ‰“åŒ… â†’ ä¸Šä¼ äº‘ç«¯ â†’ ç”Ÿæˆé“¾æ¥ â†’ æˆªå›¾ç”Ÿæˆ
    â†“         â†“         â†“         â†“         â†“         â†“         â†“
  åº”ç”¨ID    ç”¨æˆ·èº«ä»½   ä»£ç å­˜åœ¨    ZIPå‹ç¼©   å¯¹è±¡å­˜å‚¨   è®¿é—®URL   å°é¢å›¾ç‰‡
```

## 3. API æ¥å£è®¾è®¡

### 3.1 æ¥å£è§„èŒƒ

**åŸºç¡€å“åº”æ ¼å¼**:
```json
{
  "code": 0,           // çŠ¶æ€ç ï¼š0-æˆåŠŸï¼Œå…¶ä»–-å¤±è´¥
  "data": {},          // å“åº”æ•°æ®
  "message": "ok",     // å“åº”æ¶ˆæ¯
  "description": ""    // è¯¦ç»†æè¿°
}
```

**åˆ†é¡µå“åº”æ ¼å¼**:
```json
{
  "code": 0,
  "data": {
    "records": [],     // æ•°æ®åˆ—è¡¨
    "total": 100,      // æ€»è®°å½•æ•°
    "size": 10,        // æ¯é¡µå¤§å°
    "current": 1       // å½“å‰é¡µç 
  },
  "message": "ok"
}
```

### 3.2 æ ¸å¿ƒæ¥å£åˆ—è¡¨

#### 3.2.1 åº”ç”¨ç®¡ç†æ¥å£

**åˆ›å»ºåº”ç”¨**
```http
POST /api/app/add
Content-Type: application/json

{
  "appName": "æˆ‘çš„åº”ç”¨",
  "appDesc": "åº”ç”¨æè¿°",
  "appIcon": "å›¾æ ‡URL",
  "appType": 0,
  "initPrompt": "åˆ›å»ºä¸€ä¸ªå¾…åŠäº‹é¡¹åº”ç”¨"
}
```

**åº”ç”¨åˆ—è¡¨æŸ¥è¯¢**
```http
POST /api/app/my/list/page/vo
Content-Type: application/json

{
  "current": 1,
  "pageSize": 10,
  "appName": "æœç´¢å…³é”®è¯",
  "appType": 0
}
```

**åº”ç”¨è¯¦æƒ…æŸ¥è¯¢**
```http
GET /api/app/get/vo?id={appId}
```

#### 3.2.2 AI å¯¹è¯æ¥å£

**AI ä»£ç ç”Ÿæˆï¼ˆæµå¼ï¼‰**
```http
GET /api/app/chat/gen/code?appId={appId}&message={ç”¨æˆ·æç¤ºè¯}
Accept: text/event-stream
```

**å“åº”æ ¼å¼ï¼ˆSSEï¼‰**:
```
data: {"d":"ç”Ÿæˆçš„ä»£ç ç‰‡æ®µ1"}
data: {"d":"ç”Ÿæˆçš„ä»£ç ç‰‡æ®µ2"}
data: {"d":"ç”Ÿæˆçš„ä»£ç ç‰‡æ®µ3"}
event: done
data: 
```

#### 3.2.3 åº”ç”¨éƒ¨ç½²æ¥å£

**éƒ¨ç½²åº”ç”¨**
```http
POST /api/app/deploy
Content-Type: application/json

{
  "appId": 123
}
```

**ä¸‹è½½ä»£ç **
```http
GET /api/app/download/{appId}
```

### 3.3 æ¥å£æƒé™æ§åˆ¶

**æƒé™æ³¨è§£ä½¿ç”¨**:
```java
@AuthCheck(mustRole = "admin")  // éœ€è¦ç®¡ç†å‘˜æƒé™
@RateLimit(limitType = RateLimitType.USER, rate = 5, rateInterval = 60)  // é™æµæ§åˆ¶
```

**æƒé™çº§åˆ«**:
- `@AuthCheck()`: éœ€è¦ç™»å½•
- `@AuthCheck(mustRole = "admin")`: éœ€è¦ç®¡ç†å‘˜æƒé™
- `@RateLimit`: æ¥å£é™æµä¿æŠ¤

## 4. AI ä»£ç ç”Ÿæˆå®ç°

### 4.1 LangChain4j é›†æˆæ¶æ„

**AI æœåŠ¡å·¥å‚æ¨¡å¼**:
```java
@Service
public class AiCodeGeneratorServiceFactory {
    
    // ç¼“å­˜ AI æœåŠ¡å®ä¾‹ï¼Œé¿å…é‡å¤åˆ›å»º
    private final Cache<String, AiCodeGeneratorService> serviceCache = Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(Duration.ofMinutes(30))
            .build();
    
    public AiCodeGeneratorService getAiCodeGeneratorService(long appId, CodeGenTypeEnum codeGenType) {
        String cacheKey = buildCacheKey(appId, codeGenType);
        return serviceCache.get(cacheKey, key -> createAiCodeGeneratorService(appId, codeGenType));
    }
}
```

**AI æœåŠ¡åˆ›å»º**:
```java
private AiCodeGeneratorService createAiCodeGeneratorService(long appId, CodeGenTypeEnum codeGenType) {
    // 1. æ„å»ºå¯¹è¯è®°å¿†
    MessageWindowChatMemory chatMemory = MessageWindowChatMemory
            .builder()
            .id(appId)
            .chatMemoryStore(redisChatMemoryStore)
            .maxMessages(20)
            .build();
    
    // 2. åŠ è½½å†å²å¯¹è¯
    chatHistoryService.loadChatHistoryToMemory(appId, chatMemory, 20);
    
    // 3. æ ¹æ®ç±»å‹åˆ›å»ºä¸åŒæœåŠ¡
    return switch (codeGenType) {
        case VUE_PROJECT -> createVueProjectService(chatMemory);
        case HTML, MULTI_FILE -> createBasicService(chatMemory);
        default -> throw new BusinessException("ä¸æ”¯æŒçš„ä»£ç ç”Ÿæˆç±»å‹");
    };
}
```

### 4.2 ä»£ç ç”Ÿæˆç±»å‹

**HTML ä»£ç ç”Ÿæˆ**:
```java
@SystemMessage(fromResource = "prompt/codegen-html-system-prompt.txt")
HtmlCodeResult generateHtmlCode(String userMessage);

@SystemMessage(fromResource = "prompt/codegen-html-system-prompt.txt")
Flux<String> generateHtmlCodeStream(String userMessage);
```

**å¤šæ–‡ä»¶é¡¹ç›®ç”Ÿæˆ**:
```java
@SystemMessage(fromResource = "prompt/codegen-multi-file-system-prompt.txt")
MultiFileCodeResult generateMultiFileCode(String userMessage);
```

**Vue é¡¹ç›®ç”Ÿæˆ**:
```java
@SystemMessage(fromResource = "prompt/codegen-vue-project-system-prompt.txt")
TokenStream generateVueProjectCodeStream(@MemoryId long appId, @UserMessage String userMessage);
```

### 4.3 å·¥å…·è°ƒç”¨æœºåˆ¶

**å·¥å…·ç®¡ç†å™¨**:
```java
@Component
public class ToolManager {
    
    @Resource
    private List<BaseTool> tools;
    
    public List<Tool> getAllTools() {
        return tools.stream()
                .map(BaseTool::getTool)
                .collect(Collectors.toList());
    }
}
```

**å¯ç”¨å·¥å…·åˆ—è¡¨**:
- `FileDeleteTool`: æ–‡ä»¶åˆ é™¤å·¥å…·
- `FileWriteTool`: æ–‡ä»¶å†™å…¥å·¥å…·
- `ImageSearchTool`: å›¾ç‰‡æœç´¢å·¥å…·
- `LogoGeneratorTool`: Logo ç”Ÿæˆå·¥å…·
- `MermaidDiagramTool`: å›¾è¡¨ç”Ÿæˆå·¥å…·

## 5. æ•°æ®å­˜å‚¨è®¾è®¡

### 5.1 æ•°æ®åº“è¡¨ç»“æ„

**ç”¨æˆ·è¡¨ (user)**:
```sql
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',
  `userName` varchar(256) DEFAULT NULL COMMENT 'ç”¨æˆ·æ˜µç§°',
  `userAccount` varchar(256) NOT NULL COMMENT 'è´¦å·',
  `userAvatar` varchar(1024) DEFAULT NULL COMMENT 'ç”¨æˆ·å¤´åƒ',
  `userRole` varchar(256) DEFAULT 'user' COMMENT 'ç”¨æˆ·è§’è‰²ï¼šuser / admin',
  `createTime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updateTime` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `isDelete` tinyint DEFAULT '0' COMMENT 'æ˜¯å¦åˆ é™¤',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uni_userAccount` (`userAccount`)
) COMMENT='ç”¨æˆ·';
```

**åº”ç”¨è¡¨ (app)**:
```sql
CREATE TABLE `app` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',
  `appName` varchar(128) NOT NULL COMMENT 'åº”ç”¨åç§°',
  `appDesc` varchar(1024) DEFAULT NULL COMMENT 'åº”ç”¨æè¿°',
  `appIcon` varchar(1024) DEFAULT NULL COMMENT 'åº”ç”¨å›¾æ ‡',
  `appType` int NOT NULL DEFAULT '0' COMMENT 'åº”ç”¨ç±»å‹ï¼ˆ0-ä¸ªäººï¼Œ1-å®˜æ–¹ï¼‰',
  `appStatus` int NOT NULL DEFAULT '0' COMMENT 'åº”ç”¨çŠ¶æ€ï¼ˆ0-å¾…å®¡æ ¸ï¼Œ1-é€šè¿‡ï¼Œ2-æ‹’ç»ï¼‰',
  `appVersion` varchar(128) DEFAULT '1.0.0' COMMENT 'åº”ç”¨ç‰ˆæœ¬',
  `appSize` bigint DEFAULT '0' COMMENT 'åº”ç”¨å¤§å°ï¼ˆå­—èŠ‚ï¼‰',
  `userId` bigint NOT NULL COMMENT 'åˆ›å»ºç”¨æˆ· id',
  `codeGenType` varchar(128) NOT NULL COMMENT 'ä»£ç ç”Ÿæˆç±»å‹',
  `createTime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updateTime` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `isDelete` tinyint DEFAULT '0' COMMENT 'æ˜¯å¦åˆ é™¤',
  PRIMARY KEY (`id`),
  KEY `idx_userId` (`userId`)
) COMMENT='åº”ç”¨';
```

**èŠå¤©å†å²è¡¨ (chat_history)**:
```sql
CREATE TABLE `chat_history` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id',
  `appId` bigint NOT NULL COMMENT 'åº”ç”¨ id',
  `userId` bigint NOT NULL COMMENT 'ç”¨æˆ· id',
  `messageType` int NOT NULL COMMENT 'æ¶ˆæ¯ç±»å‹ï¼ˆ0-ç”¨æˆ·ï¼Œ1-AIï¼‰',
  `messageContent` text COMMENT 'æ¶ˆæ¯å†…å®¹',
  `createTime` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updateTime` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `isDelete` tinyint DEFAULT '0' COMMENT 'æ˜¯å¦åˆ é™¤',
  PRIMARY KEY (`id`),
  KEY `idx_appId` (`appId`),
  KEY `idx_userId` (`userId`)
) COMMENT='èŠå¤©è®°å½•';
```

### 5.2 ç¼“å­˜ç­–ç•¥

**å¤šçº§ç¼“å­˜è®¾è®¡**:
```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager() {
        CaffeineCacheManager cacheManager = new CaffeineCacheManager();
        cacheManager.setCaffeine(Caffeine.newBuilder()
                .maximumSize(1000)           // æœ€å¤§ç¼“å­˜æ¡ç›®æ•°
                .expireAfterWrite(10, TimeUnit.MINUTES)  // å†™å…¥åè¿‡æœŸæ—¶é—´
                .recordStats());             // è®°å½•ç»Ÿè®¡ä¿¡æ¯
        return cacheManager;
    }
}
```

**ç¼“å­˜ä½¿ç”¨ç¤ºä¾‹**:
```java
@Service
public class AppServiceImpl implements AppService {
    
    @Cacheable(value = "app", key = "#appId")
    public App getAppById(Long appId) {
        return appMapper.selectOneById(appId);
    }
    
    @CacheEvict(value = "app", key = "#app.id")
    public boolean updateApp(App app) {
        return appMapper.updateById(app) > 0;
    }
}
```

## 6. å®‰å…¨ä¸é™æµæœºåˆ¶

### 6.1 èº«ä»½è®¤è¯

**Session ç®¡ç†**:
```yaml
spring:
  session:
    store-type: redis
    timeout: 2592000  # 30å¤©è¿‡æœŸ
```

**ç”¨æˆ·ç™»å½•éªŒè¯**:
```java
@Component
public class AuthInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æƒé™éªŒè¯
        if (handler instanceof HandlerMethod) {
            HandlerMethod handlerMethod = (HandlerMethod) handler;
            AuthCheck authCheck = handlerMethod.getMethodAnnotation(AuthCheck.class);
            if (authCheck != null) {
                return checkAuth(request, authCheck);
            }
        }
        return true;
    }
}
```

### 6.2 åˆ†å¸ƒå¼é™æµ

**Redisson é™æµé…ç½®**:
```java
@Configuration
public class RedissonConfig {
    
    @Bean
    public RedissonClient redissonClient() {
        Config config = new Config();
        config.useSingleServer()
                .setAddress("redis://localhost:6379")
                .setDatabase(0);
        return Redisson.create(config);
    }
}
```

**é™æµæ³¨è§£ä½¿ç”¨**:
```java
@RateLimit(limitType = RateLimitType.USER, rate = 5, rateInterval = 60, 
           message = "AI å¯¹è¯è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•")
public Flux<ServerSentEvent<String>> chatToGenCode(...) {
    // æ–¹æ³•å®ç°
}
```

**é™æµç±»å‹**:
- `RateLimitType.USER`: æŒ‰ç”¨æˆ·é™æµ
- `RateLimitType.IP`: æŒ‰ IP é™æµ
- `RateLimitType.GLOBAL`: å…¨å±€é™æµ

### 6.3 è¾“å…¥å®‰å…¨

**æç¤ºè¯å®‰å…¨æ£€æŸ¥**:
```java
@Component
public class PromptSafetyInputGuardrail implements InputGuardrail {
    
    @Override
    public void validate(String input) {
        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ¶æ„å†…å®¹
        if (containsMaliciousContent(input)) {
            throw new InputGuardrailException("è¾“å…¥å†…å®¹åŒ…å«ä¸å½“ä¿¡æ¯");
        }
    }
}
```

## 7. æµå¼å“åº”å®ç°

### 7.1 SSE æµå¼å“åº”

**æ§åˆ¶å™¨å®ç°**:
```java
@GetMapping(value = "/chat/gen/code", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
@RateLimit(limitType = RateLimitType.USER, rate = 5, rateInterval = 60)
public Flux<ServerSentEvent<String>> chatToGenCode(@RequestParam Long appId,
                                                   @RequestParam String message,
                                                   HttpServletRequest request) {
    // 1. å‚æ•°æ ¡éªŒ
    ThrowUtils.throwIf(appId == null || appId <= 0, ErrorCode.PARAMS_ERROR, "åº”ç”¨ id é”™è¯¯");
    ThrowUtils.throwIf(StrUtil.isBlank(message), ErrorCode.PARAMS_ERROR, "æç¤ºè¯ä¸èƒ½ä¸ºç©º");
    
    // 2. è·å–å½“å‰ç™»å½•ç”¨æˆ·
    User loginUser = userService.getLoginUser(request);
    
    // 3. è°ƒç”¨æœåŠ¡ç”Ÿæˆä»£ç ï¼ˆSSE æµå¼è¿”å›ï¼‰
    Flux<String> contentFlux = appService.chatToGenCode(appId, message, loginUser);
    
    // 4. è½¬æ¢ä¸º SSE æ ¼å¼
    return contentFlux
            .map(chunk -> {
                Map<String, String> wrapper = Map.of("d", chunk);
                String jsonData = JSONUtil.toJsonStr(wrapper);
                return ServerSentEvent.<String>builder()
                        .data(jsonData)
                        .build();
            })
            .concatWith(Mono.just(
                // å‘é€ç»“æŸäº‹ä»¶
                ServerSentEvent.<String>builder()
                        .event("done")
                        .data("")
                        .build()
            ));
}
```

### 7.2 æµå¼å¤„ç†æµç¨‹

**æµå¼ä»£ç ç”Ÿæˆ**:
```java
@Override
public Flux<String> chatToGenCode(Long appId, String message, User loginUser) {
    // 1. å‚æ•°æ ¡éªŒå’Œæƒé™éªŒè¯
    // 2. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°æ•°æ®åº“
    // 3. è®¾ç½®ç›‘æ§ä¸Šä¸‹æ–‡
    // 4. è°ƒç”¨ AI ç”Ÿæˆä»£ç ï¼ˆæµå¼ï¼‰
    Flux<String> codeStream = aiCodeGeneratorFacade.generateAndSaveCodeStream(message, codeGenTypeEnum, appId);
    
    // 5. å¤„ç†æµå¼å“åº”
    return streamHandlerExecutor.doExecute(codeStream, chatHistoryService, appId, loginUser, codeGenTypeEnum)
            .doFinally(signalType -> {
                // æµç»“æŸæ—¶æ¸…ç†ç›‘æ§ä¸Šä¸‹æ–‡
                MonitorContextHolder.clearContext();
            });
}
```

**æµå¼å¤„ç†å™¨**:
```java
@Component
public class StreamHandlerExecutor {
    
    public Flux<String> doExecute(Flux<String> codeStream, 
                                 ChatHistoryService chatHistoryService,
                                 Long appId, User loginUser, CodeGenTypeEnum codeGenTypeEnum) {
        return codeStream
                .doOnNext(chunk -> {
                    // å®æ—¶å¤„ç†æ¯ä¸ªä»£ç ç‰‡æ®µ
                    log.debug("æ”¶åˆ°ä»£ç ç‰‡æ®µ: {}", chunk);
                })
                .doOnComplete(() -> {
                    // æµå¼å“åº”å®Œæˆï¼Œä¿å­˜ AI å›å¤åˆ°æ•°æ®åº“
                    chatHistoryService.addChatMessage(appId, 
                        "ä»£ç ç”Ÿæˆå®Œæˆ", 
                        ChatHistoryMessageTypeEnum.AI.getValue(), 
                        loginUser.getId());
                });
    }
}
```

## 8. éƒ¨ç½²ä¸è¿ç»´

### 8.1 åº”ç”¨éƒ¨ç½²æµç¨‹

**éƒ¨ç½²æœåŠ¡å®ç°**:
```java
@Override
public String deployApp(Long appId, User loginUser) {
    // 1. å‚æ•°æ ¡éªŒ
    ThrowUtils.throwIf(appId == null || appId <= 0, ErrorCode.PARAMS_ERROR, "åº”ç”¨ ID é”™è¯¯");
    
    // 2. æŸ¥è¯¢åº”ç”¨ä¿¡æ¯
    App app = this.getById(appId);
    ThrowUtils.throwIf(app == null, ErrorCode.NOT_FOUND_ERROR, "åº”ç”¨ä¸å­˜åœ¨");
    
    // 3. æƒé™æ ¡éªŒ
    if (!app.getUserId().equals(loginUser.getId())) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ— æƒé™éƒ¨ç½²è¯¥åº”ç”¨");
    }
    
    // 4. æ£€æŸ¥ä»£ç æ˜¯å¦å­˜åœ¨
    String codeGenType = app.getCodeGenType();
    String sourceDirName = codeGenType + "_" + appId;
    String sourceDirPath = AppConstant.CODE_OUTPUT_ROOT_DIR + File.separator + sourceDirName;
    
    File sourceDir = new File(sourceDirPath);
    ThrowUtils.throwIf(!sourceDir.exists() || !sourceDir.isDirectory(),
            ErrorCode.NOT_FOUND_ERROR, "åº”ç”¨ä»£ç ä¸å­˜åœ¨ï¼Œè¯·å…ˆç”Ÿæˆä»£ç ");
    
    // 5. éƒ¨ç½²åˆ°äº‘ç«¯
    String deployUrl = deployToCloud(sourceDirPath, appId);
    
    // 6. å¼‚æ­¥ç”Ÿæˆæˆªå›¾
    screenshotService.generateAppScreenshotAsync(appId, deployUrl);
    
    return deployUrl;
}
```

### 8.2 ç›‘æ§ç³»ç»Ÿ

**AI æœåŠ¡ç›‘æ§**:
```java
@Component
public class AiModelMonitorListener {
    
    @EventListener
    public void handleAiModelCall(AiModelCallEvent event) {
        // è®°å½• AI æ¨¡å‹è°ƒç”¨ç»Ÿè®¡
        String modelName = event.getModelName();
        long responseTime = event.getResponseTime();
        boolean success = event.isSuccess();
        
        // æ›´æ–°ç›‘æ§æŒ‡æ ‡
        updateMetrics(modelName, responseTime, success);
    }
}
```

**ç›‘æ§æŒ‡æ ‡**:
- AI æ¨¡å‹è°ƒç”¨æ¬¡æ•°
- å“åº”æ—¶é—´ç»Ÿè®¡
- æˆåŠŸç‡ç»Ÿè®¡
- æˆæœ¬ç»Ÿè®¡

## 9. å‰ç«¯è°ƒç”¨ç¤ºä¾‹

### 9.1 åŸºç¡€ HTTP è¯·æ±‚

**åˆ›å»ºåº”ç”¨**:
```javascript
const createApp = async (appData) => {
  try {
    const response = await fetch('/api/app/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include', // åŒ…å« cookies
      body: JSON.stringify(appData)
    });
    
    if (!response.ok) {
      throw new Error('åˆ›å»ºåº”ç”¨å¤±è´¥');
    }
    
    const result = await response.json();
    if (result.code === 0) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('åˆ›å»ºåº”ç”¨å¤±è´¥:', error);
    throw error;
  }
};
```

**æŸ¥è¯¢åº”ç”¨åˆ—è¡¨**:
```javascript
const getAppList = async (params = {}) => {
  try {
    const response = await fetch('/api/app/my/list/page/vo', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify({
        current: 1,
        pageSize: 10,
        ...params
      })
    });
    
    const result = await response.json();
    if (result.code === 0) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('è·å–åº”ç”¨åˆ—è¡¨å¤±è´¥:', error);
    throw error;
  }
};
```

### 9.2 SSE æµå¼è¯·æ±‚

**AI ä»£ç ç”Ÿæˆ**:
```javascript
const generateCode = async (appId, message, onChunk, onComplete) => {
  try {
    const url = `/api/app/chat/gen/code?appId=${appId}&message=${encodeURIComponent(message)}`;
    const eventSource = new EventSource(url);
    
    let fullResponse = '';
    
    eventSource.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.d) {
          fullResponse += data.d;
          onChunk(data.d); // å®æ—¶æ˜¾ç¤ºä»£ç ç‰‡æ®µ
        }
      } catch (e) {
        console.error('è§£æå“åº”æ•°æ®å¤±è´¥:', e);
      }
    };
    
    eventSource.addEventListener('done', () => {
      onComplete(fullResponse); // ä»£ç ç”Ÿæˆå®Œæˆ
      eventSource.close();
    });
    
    eventSource.onerror = (error) => {
      console.error('SSE è¿æ¥é”™è¯¯:', error);
      eventSource.close();
    };
    
  } catch (error) {
    console.error('ä»£ç ç”Ÿæˆå¤±è´¥:', error);
    throw error;
  }
};

// ä½¿ç”¨ç¤ºä¾‹
generateCode(
  123, 
  "åˆ›å»ºä¸€ä¸ªå¾…åŠäº‹é¡¹åº”ç”¨",
  (chunk) => {
    // å®æ—¶æ˜¾ç¤ºä»£ç ç‰‡æ®µ
    console.log('æ”¶åˆ°ä»£ç ç‰‡æ®µ:', chunk);
  },
  (fullCode) => {
    // ä»£ç ç”Ÿæˆå®Œæˆ
    console.log('å®Œæ•´ä»£ç :', fullCode);
  }
);
```

### 9.3 æ–‡ä»¶ä¸‹è½½

**ä¸‹è½½åº”ç”¨ä»£ç **:
```javascript
const downloadAppCode = async (appId) => {
  try {
    const response = await fetch(`/api/app/download/${appId}`, {
      method: 'GET',
      credentials: 'include',
    });
    
    if (!response.ok) {
      throw new Error('ä¸‹è½½å¤±è´¥');
    }
    
    // è·å–æ–‡ä»¶å
    const contentDisposition = response.headers.get('content-disposition');
    const filename = contentDisposition ? 
      contentDisposition.split('filename=')[1]?.replace(/"/g, '') : 
      `app_${appId}.zip`;
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
  } catch (error) {
    console.error('ä¸‹è½½ä»£ç å¤±è´¥:', error);
    throw error;
  }
};
```

### 9.4 é”™è¯¯å¤„ç†

**ç»Ÿä¸€é”™è¯¯å¤„ç†**:
```javascript
class ApiError extends Error {
  constructor(code, message, description = '') {
    super(message);
    this.code = code;
    this.description = description;
  }
}

const handleApiResponse = (response) => {
  if (!response.ok) {
    throw new ApiError(response.status, `HTTP ${response.status}: ${response.statusText}`);
  }
  
  return response.json().then(data => {
    if (data.code === 0) {
      return data.data;
    } else {
      throw new ApiError(data.code, data.message, data.description);
    }
  });
};

// ä½¿ç”¨ç¤ºä¾‹
const safeApiCall = async (apiFunction) => {
  try {
    return await apiFunction();
  } catch (error) {
    if (error instanceof ApiError) {
      // å¤„ç†ä¸šåŠ¡é”™è¯¯
      console.error(`ä¸šåŠ¡é”™è¯¯ ${error.code}: ${error.message}`);
      // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
      showErrorMessage(error.message);
    } else {
      // å¤„ç†ç½‘ç»œé”™è¯¯
      console.error('ç½‘ç»œé”™è¯¯:', error);
      showErrorMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®');
    }
    throw error;
  }
};
```

## 10. å¸¸è§é—®é¢˜è§£ç­”

### 10.1 å‰ç«¯å¼€å‘è€…å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆæˆ‘çš„è¯·æ±‚æ€»æ˜¯è¿”å› 401 é”™è¯¯ï¼Ÿ**
A: è¿™é€šå¸¸æ˜¯å› ä¸ºç”¨æˆ·æœªç™»å½•æˆ– Session è¿‡æœŸã€‚è¯·ç¡®ä¿ï¼š
1. ç”¨æˆ·å·²ç»ç™»å½•
2. è¯·æ±‚åŒ…å« `credentials: 'include'`
3. æ£€æŸ¥æµè§ˆå™¨ Cookie æ˜¯å¦æ­£å¸¸

**Q: SSE è¿æ¥ä¸ºä»€ä¹ˆç»å¸¸æ–­å¼€ï¼Ÿ**
A: SSE è¿æ¥å¯èƒ½å› ä¸ºä»¥ä¸‹åŸå› æ–­å¼€ï¼š
1. ç½‘ç»œä¸ç¨³å®š
2. æœåŠ¡å™¨è¶…æ—¶
3. æµè§ˆå™¨é™åˆ¶
å»ºè®®å®ç°è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼š

```javascript
const createSSEConnection = (url, options) => {
  let eventSource = null;
  let reconnectAttempts = 0;
  const maxReconnectAttempts = 5;
  
  const connect = () => {
    eventSource = new EventSource(url);
    
    eventSource.onopen = () => {
      console.log('SSE è¿æ¥å·²å»ºç«‹');
      reconnectAttempts = 0;
    };
    
    eventSource.onerror = () => {
      eventSource.close();
      if (reconnectAttempts < maxReconnectAttempts) {
        reconnectAttempts++;
        console.log(`SSE è¿æ¥æ–­å¼€ï¼Œ${reconnectAttempts}ç§’åé‡è¿...`);
        setTimeout(connect, reconnectAttempts * 1000);
      }
    };
    
    return eventSource;
  };
  
  return connect();
};
```

**Q: å¦‚ä½•ä¼˜åŒ–å¤§æ–‡ä»¶çš„ä¸‹è½½ä½“éªŒï¼Ÿ**
A: å¯¹äºå¤§æ–‡ä»¶ä¸‹è½½ï¼Œå»ºè®®ï¼š
1. æ˜¾ç¤ºä¸‹è½½è¿›åº¦
2. æ”¯æŒæ–­ç‚¹ç»­ä¼ 
3. æä¾›å–æ¶ˆä¸‹è½½åŠŸèƒ½

```javascript
const downloadWithProgress = async (url, filename) => {
  const response = await fetch(url, { credentials: 'include' });
  const reader = response.body.getReader();
  const contentLength = +response.headers.get('content-length');
  
  let receivedLength = 0;
  const chunks = [];
  
  while (true) {
    const { done, value } = await reader.read();
    
    if (done) break;
    
    chunks.push(value);
    receivedLength += value.length;
    
    // æ›´æ–°è¿›åº¦
    const progress = (receivedLength / contentLength) * 100;
    updateProgress(progress);
  }
  
  // åˆå¹¶æ•°æ®å—å¹¶ä¸‹è½½
  const blob = new Blob(chunks);
  const downloadUrl = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = downloadUrl;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(downloadUrl);
};
```

### 10.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

**å‰ç«¯ä¼˜åŒ–**:
1. ä½¿ç”¨é˜²æŠ–å¤„ç†æœç´¢è¾“å…¥
2. å®ç°è™šæ‹Ÿæ»šåŠ¨å¤„ç†é•¿åˆ—è¡¨
3. åˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è¯·æ±‚
4. å›¾ç‰‡æ‡’åŠ è½½å’Œå‹ç¼©

**åç«¯ä¼˜åŒ–**:
1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å’Œç´¢å¼•
2. Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
3. å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œ
4. åˆç†çš„é™æµç­–ç•¥

### 10.3 è°ƒè¯•æŠ€å·§

**åç«¯æ—¥å¿—æŸ¥çœ‹**:
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/application.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep "ERROR" logs/application.log

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„è¯·æ±‚
grep "userId: 123" logs/application.log
```

**å‰ç«¯è°ƒè¯•**:
```javascript
// å¼€å¯è¯¦ç»†æ—¥å¿—
localStorage.setItem('debug', 'true');

// ç›‘æ§ API è¯·æ±‚
const originalFetch = window.fetch;
window.fetch = function(...args) {
  console.log('API è¯·æ±‚:', args);
  return originalFetch.apply(this, args).then(response => {
    console.log('API å“åº”:', response);
    return response;
  });
};
```

---

## ğŸ“š æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº† AI é›¶ä»£ç åº”ç”¨ç”Ÿæˆå¹³å°çš„åç«¯å®ç°ï¼ŒåŒ…æ‹¬ï¼š

1. **æ¶æ„è®¾è®¡**: åˆ†å±‚æ¶æ„ã€åŒ…ç»“æ„ã€è®¾è®¡æ¨¡å¼
2. **æ ¸å¿ƒåŠŸèƒ½**: AI ä»£ç ç”Ÿæˆã€å·¥ä½œæµå¼•æ“ã€åº”ç”¨ç®¡ç†
3. **æŠ€æœ¯å®ç°**: LangChain4j é›†æˆã€æµå¼å“åº”ã€ç¼“å­˜ç­–ç•¥
4. **å®‰å…¨æœºåˆ¶**: èº«ä»½è®¤è¯ã€æƒé™æ§åˆ¶ã€é™æµä¿æŠ¤
5. **å‰ç«¯é›†æˆ**: API è°ƒç”¨ã€SSE å¤„ç†ã€é”™è¯¯å¤„ç†

ä½œä¸ºå‰ç«¯å¼€å‘è€…ï¼Œç†è§£è¿™äº›åç«¯å®ç°ç»†èŠ‚å°†å¸®åŠ©ä½ ï¼š
- æ›´å¥½åœ°è®¾è®¡å‰ç«¯æ¶æ„
- ä¼˜åŒ– API è°ƒç”¨é€»è¾‘
- å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
- æå‡ç”¨æˆ·ä½“éªŒ

å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦æ›´è¯¦ç»†çš„è¯´æ˜ï¼Œè¯·éšæ—¶è”ç³»åç«¯å¼€å‘å›¢é˜Ÿï¼
